# Codebase Report: GEKO Webapp - Articles & LLM Integration
Generated: 2026-01-19 17:37:46

## Summary
The GEKO Magazine webapp uses FastAPI with SQLAlchemy async models, Jinja2 templates, and HTMX for dynamic UI. AI summary generation is currently hardcoded to use Claude 3.5 Haiku via the Anthropic API. The configuration system exists but doesn't yet include model selection.

## Project Structure
```
webapp/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ models.py              # SQLAlchemy models (Article, Config, Image, Magazine)
â”‚   â”œâ”€â”€ database.py            # Async DB setup
â”‚   â”œâ”€â”€ main.py                # FastAPI entry point
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ articles.py        # Article CRUD + AI summary generation
â”‚   â”‚   â”œâ”€â”€ config.py          # Global config panel
â”‚   â”‚   â”œâ”€â”€ magazines.py       # Magazine management
â”‚   â”‚   â””â”€â”€ upload.py          # Image uploads
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ llm.py             # Anthropic API integration
â”‚   â”‚   â”œâ”€â”€ builder.py         # PDF generation via Typst
â”‚   â”‚   â””â”€â”€ converter.py       # Markdown â†’ Typst conversion
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ standard/
â”‚           â”œâ”€â”€ articles/      # Article templates
â”‚           â”œâ”€â”€ config/        # Config panel
â”‚           â””â”€â”€ base.html      # Base layout
```

## Questions Answered

### Q1: Where is the articles list page rendered?

**Location:** `/home/sf/src/geko-template/webapp/app/templates/standard/articles/list.html`

**Route:** `GET /articles/` in `/home/sf/src/geko-template/webapp/app/routes/articles.py:44`

**Function:** `list_articles(request, db)` - queries all articles with SQLAlchemy async

**Template Structure:**
- Main list: `list.html` 
- Individual items: `list_item.html` (partial for HTMX)
- Uses `{% include "standard/articles/list_item.html" %}` for each article

**Key Elements:**
- Article cards show: title, subtitle, author, creation date
- Badges for: magazine assignments, AI summary status
- HTMX-powered actions: assign, generate summary, edit, delete

---

### Q2: How is AI summary generation currently triggered?

**Trigger:** Button in article list item template

**Location:** `/home/sf/src/geko-template/webapp/app/templates/standard/articles/list_item.html:71-83`

```html
{% if not article.sommario_llm %}
<button
    class="btn btn-small btn-outline"
    hx-post="/articles/{{ article.id }}/summary"
    hx-target="#article-{{ article.id }}"
    hx-swap="outerHTML"
    hx-indicator="#loading-{{ article.id }}"
    title="Genera sommario con AI"
>
    ðŸ¤– Genera sommario
</button>
<span id="loading-{{ article.id }}" class="htmx-indicator">Generando...</span>
{% endif %}
```

**API Endpoint:** `POST /articles/{article_id}/summary`

**Route Handler:** `/home/sf/src/geko-template/webapp/app/routes/articles.py:234-261`

```python
async def generate_summary(
    request: Request,
    article_id: int,
    db: AsyncSession = Depends(get_db)
):
    """Generate AI summary for article."""
    result = await db.execute(
        select(Article).where(Article.id == article_id)
    )
    article = result.scalar_one_or_none()

    if not article:
        raise HTTPException(status_code=404, detail="Articolo non trovato")

    # Generate summary using Claude
    summary_data = await generate_article_summary(
        article.contenuto_md,
        article.titolo
    )

    article.sommario_llm = summary_data.get("sommario", "")
    await db.commit()

    templates = request.app.state.templates
    return templates.TemplateResponse(
        "standard/articles/summary_badge.html",
        {"request": request, "article": article, "summary": summary_data}
    )
```

**Response:** HTMX partial (`summary_badge.html`) replaces the generate button

---

### Q3: What's the data model for articles (specifically AI-related fields)?

**Location:** `/home/sf/src/geko-template/webapp/app/models.py:51-74`

**Article Model Fields:**

| Field | Type | AI-Related | Description |
|-------|------|------------|-------------|
| `id` | Integer | No | Primary key |
| `titolo` | String(200) | No | Title |
| `sottotitolo` | String(300) | No | Subtitle |
| `autore` | String(50) | No | Call sign |
| `nome_autore` | String(100) | No | Real name |
| `contenuto_md` | Text | **Input** | Original markdown content |
| `contenuto_typ` | Text | No | Generated Typst |
| `sommario_llm` | Text | **âœ“ YES** | AI-generated summary from Claude |
| `ordine` | Integer | No | Display order |
| `created_at` | DateTime | No | Creation timestamp |
| `updated_at` | DateTime | No | Last update timestamp |

**AI Field Details:**
- `sommario_llm`: Stores the Claude-generated summary (2-3 sentences)
- Used for "In Evidenza" (Featured) section on magazine cover
- Optional field (defaults to empty string)
- UI shows badge: "âœ“ Sommario AI" if present, "Senza sommario" if empty

**Relationships:**
- `magazines` (many-to-many): Which GEKO issues include this article
- `images` (one-to-many): Images embedded in the article

---

### Q4: What API endpoints exist for articles?

**Router Prefix:** `/articles`

**Location:** `/home/sf/src/geko-template/webapp/app/routes/articles.py`

| Method | Endpoint | Function | Description |
|--------|----------|----------|-------------|
| GET | `/articles/` | `list_articles` | List all articles (HTML page) |
| GET | `/articles/new` | `new_article_form` | Show create form |
| POST | `/articles/` | `create_article` | Create new article |
| GET | `/articles/{id}` | `get_article` | Article detail page |
| GET | `/articles/{id}/edit` | `edit_article_form` | Show edit form |
| PUT | `/articles/{id}` | `update_article` | Update article |
| DELETE | `/articles/{id}` | `delete_article` | Delete article |
| **POST** | **`/articles/{id}/summary`** | **`generate_summary`** | **Generate AI summary** |
| GET | `/articles/{id}/assign` | `assign_article_form` | Show magazine assignment form |
| POST | `/articles/{id}/assign` | `assign_article` | Assign to magazines |

**All routes return HTML** (not JSON) - designed for HTMX interaction

---

### Q5: Where is the settings/config page?

**Template:** `/home/sf/src/geko-template/webapp/app/templates/standard/config/panel.html`

**Route:** `GET /config/` in `/home/sf/src/geko-template/webapp/app/routes/config.py:23-35`

**Current Configuration Fields:**

| Field | Default | Description |
|-------|---------|-------------|
| `ultimo_numero` | "67" | Latest GEKO issue number |
| `titolo_rivista` | "GEKO Radio Magazine" | Magazine title |
| `sottotitolo_rivista` | "Rivista aperiodica del Mountain QRP Club" | Subtitle |
| `sito_web` | "https://www.mqc.it" | Website URL |
| `email_redazione` | "redazione@mqc.it" | Editorial email |

**Note:** Config panel includes a disabled "Template Typst (prossimamente)" section for future custom templates

**Additional Feature:** Config panel also has an "AI Tools" section with a button to regenerate all image captions using Claude Vision (lines 122-142)

---

### Q6: How is configuration currently stored and loaded?

**Storage Model:** `/home/sf/src/geko-template/webapp/app/models.py:106-180`

**Table:** `config` (key-value store)

**Schema:**
```python
class Config(Base):
    key = Column(String(100), primary_key=True)
    value = Column(Text, default="")
    description = Column(String(500), default="")
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    DEFAULTS = {
        "ultimo_numero": ("67", "Numero dell'ultimo GEKO pubblicato"),
        "titolo_rivista": ("GEKO Radio Magazine", "Titolo della rivista"),
        "sottotitolo_rivista": ("Rivista aperiodica del Mountain QRP Club", "Sottotitolo/descrizione"),
        "sito_web": ("https://www.mqc.it", "Sito web del club"),
        "email_redazione": ("redazione@mqc.it", "Email della redazione"),
    }
```

**API Methods:**
- `Config.get(db, key, default)` â†’ Get single value
- `Config.set(db, key, value, description)` â†’ Set value
- `Config.get_all(db)` â†’ Get all as dict

**Initialization:** Values auto-populate from `DEFAULTS` if not in DB (line 174-180)

---

### Q7: Is there an existing API for settings?

**Yes**, 3 endpoints:

**Location:** `/home/sf/src/geko-template/webapp/app/routes/config.py`

| Method | Endpoint | Function | Response |
|--------|----------|----------|----------|
| GET | `/config/` | `config_panel` | HTML panel (line 23) |
| POST | `/config/` | `save_config` | HTML panel with success message (line 38) |
| GET | `/config/{key}` | `get_config_value` | **JSON** - single value (line 66) |

**JSON API Example:**
```python
@router.get("/{key}")
async def get_config_value(
    key: str,
    db: AsyncSession = Depends(get_db)
):
    """Ottiene un singolo valore di configurazione (API JSON)."""
    value = await Config.get(db, key)
    return JSONResponse({"key": key, "value": value})
```

**Usage:** The JSON endpoint can be used to fetch config values programmatically

---

### Q8: Where is the Anthropic API integration?

**Location:** `/home/sf/src/geko-template/webapp/app/services/llm.py`

**Service Class:** `ClaudeSummaryService` (line 48)

**Current Implementation:**

```python
class ClaudeSummaryService:
    def __init__(self, api_key: Optional[str] = None):
        self.api_key = api_key or _load_api_key()
        self.base_url = "https://api.anthropic.com/v1/messages"
        # Haiku 3.5: economico ($0.25-1.25/1M token), veloce, qualitÃ  buona per sommari
        self.model = "claude-3-5-haiku-20241022"  # â† HARDCODED
```

**API Key Loading (Priority Order):**
1. Parameter: `ClaudeSummaryService(api_key="sk-...")`
2. File: `ANTHROPIC_API_KEY_FILE=/path/to/file`
3. Environment: `ANTHROPIC_API_KEY=sk-...`

**Function:** `_load_api_key()` at line 26

---

### Q9: How is the model currently selected?

**Current State:** **HARDCODED** to `claude-3-5-haiku-20241022`

**Location:** `/home/sf/src/geko-template/webapp/app/services/llm.py:62`

```python
self.model = "claude-3-5-haiku-20241022"
```

**Used In:**
- `generate_summary()` method (line 104)
- `generate_image_caption()` function (line 175)

**No config integration** - model selection is not yet configurable

---

### Q10: What prompts are used for summary generation?

**Location:** `/home/sf/src/geko-template/webapp/app/services/llm.py:82-93`

**Summary Prompt:**
```python
prompt = f"""Riassumi questo articolo per una rivista radioamatoriale in 2-3 frasi.
Il riassunto deve essere adatto per la sezione "In Evidenza" della copertina.
Tono: informale, tecnico ma accessibile.

Titolo: {article_title}

Contenuto:
{article_content[:3000]}

Rispondi SOLO con un JSON valido in questo formato:
{{"sommario": "Il riassunto qui...", "keywords": ["keyword1", "keyword2", "keyword3"]}}"""
```

**Notes:**
- Only first 3000 chars of content used
- Italian language
- Context: amateur radio magazine ("rivista radioamatoriale")
- Output: JSON with `sommario` and `keywords` fields
- Max tokens: 500
- Timeout: 30 seconds

**Response Parsing:**
- Handles markdown code blocks (```json)
- Extracts JSON from Claude response
- Stores `sommario` in `Article.sommario_llm`

---

## Architecture Map

### Request Flow for AI Summary Generation

```
[User clicks "ðŸ¤– Genera sommario" button]
        â†“
[HTMX POST â†’ /articles/{id}/summary]
        â†“
[articles.py:generate_summary()]
        â”œâ†’ Fetch Article from DB
        â”œâ†’ Call generate_article_summary(content, title)
        â”‚   â†“
        â”‚   [llm.py:generate_article_summary()]
        â”‚   â”œâ†’ get_summary_service() (singleton)
        â”‚   â””â†’ ClaudeSummaryService.generate_summary()
        â”‚       â”œâ†’ Build prompt
        â”‚       â”œâ†’ POST to Anthropic API
        â”‚       â””â†’ Parse JSON response
        â†“
        â”œâ†’ Save sommario_llm to DB
        â””â†’ Return summary_badge.html (HTMX partial)
            â†“
[HTMX replaces button with success badge + summary text]
```

### Config System Architecture

```
[Config Panel UI]
        â†“
[POST /config/]
        â†“
[config.py:save_config()]
        â”œâ†’ Parse form data
        â”œâ†’ For each key in DEFAULTS:
        â”‚   â””â†’ Config.set(db, key, value)
        â”‚       â”œâ†’ Check if exists
        â”‚       â”œâ†’ Update or create row
        â”‚       â””â†’ Commit to DB
        â””â†’ Return panel with success message
```

---

## Key Files

| File | Purpose | Entry Points |
|------|---------|--------------|
| `/home/sf/src/geko-template/webapp/app/models.py` | Data models | `Article`, `Config`, `Magazine`, `Image` |
| `/home/sf/src/geko-template/webapp/app/routes/articles.py` | Article CRUD | `list_articles()`, `generate_summary()` |
| `/home/sf/src/geko-template/webapp/app/routes/config.py` | Config panel | `config_panel()`, `save_config()` |
| `/home/sf/src/geko-template/webapp/app/services/llm.py` | AI integration | `ClaudeSummaryService`, `generate_article_summary()` |
| `/home/sf/src/geko-template/webapp/app/templates/standard/articles/list.html` | Articles page | Main list view |
| `/home/sf/src/geko-template/webapp/app/templates/standard/articles/list_item.html` | Article card | HTMX partial with generate button |
| `/home/sf/src/geko-template/webapp/app/templates/standard/config/panel.html` | Config UI | Settings form |

---

## Conventions Discovered

### Code Style
- **Language:** Italian for UI strings, English for code/comments
- **Async:** All DB operations use `async/await`
- **Type hints:** Used throughout (`str`, `int`, `Optional`, `AsyncSession`)
- **Docstrings:** Italian for user-facing, mixed for internal

### Naming
- **Routes:** Italian names (`lista_articoli`, `genera_sommario`)
- **Functions:** Snake_case (`generate_summary`, `config_panel`)
- **Classes:** PascalCase (`Article`, `ClaudeSummaryService`)
- **Templates:** Snake_case paths (`articles/list_item.html`)

### Database
- **ORM:** SQLAlchemy with async support
- **Driver:** `aiosqlite` (async SQLite)
- **Pattern:** Dependency injection via `Depends(get_db)`
- **Queries:** Using `select()` construct, not raw SQL

### Frontend
- **Templates:** Jinja2 with HTMX attributes
- **HTMX patterns:**
  - `hx-post`, `hx-get`, `hx-delete` for actions
  - `hx-target`, `hx-swap` for dynamic updates
  - `hx-indicator` for loading states
- **Partials:** Separate templates for HTMX responses (`summary_badge.html`, `list_item.html`)

### API Patterns
- **Responses:** Primarily HTML (for HTMX), some JSON (`/config/{key}`)
- **Error handling:** `HTTPException(status_code=404)`
- **Form parsing:** `Form(...)` dependency from FastAPI

---

## Current Model Selection Architecture

**Issue:** Model is hardcoded in service class

**Current Flow:**
```
ClaudeSummaryService.__init__()
    â†“
self.model = "claude-3-5-haiku-20241022"  # HARDCODED
    â†“
Used in all API calls
```

**No connection to Config system** - the Config table doesn't include a `claude_model` key

**Singleton pattern:** `get_summary_service()` creates one instance (line 161), so model can't change without restart

---

## Recommendations for Model Selection Feature

Based on discovered architecture:

### 1. Add to Config Model
Add `claude_model` to `Config.DEFAULTS`:
```python
DEFAULTS = {
    # ... existing keys ...
    "claude_model": ("claude-3-5-haiku-20241022", "Modello Claude per sommari"),
}
```

### 2. Update Config Panel Template
Add dropdown in `/home/sf/src/geko-template/webapp/app/templates/standard/config/panel.html`:
- After "Contatti" section
- Before "Template Typst" section
- Options: Haiku 3.5, Sonnet 4, Opus 4.5

### 3. Modify ClaudeSummaryService
Change `__init__` to accept model parameter:
```python
def __init__(self, api_key: Optional[str] = None, model: Optional[str] = None):
    self.api_key = api_key or _load_api_key()
    self.model = model or "claude-3-5-haiku-20241022"
```

### 4. Update get_summary_service()
Fetch model from Config:
```python
async def get_summary_service(db: AsyncSession) -> ClaudeSummaryService:
    model = await Config.get(db, "claude_model", "claude-3-5-haiku-20241022")
    return ClaudeSummaryService(model=model)
```

### 5. Update Routes
Pass `db` to `get_summary_service()` in:
- `/home/sf/src/geko-template/webapp/app/routes/articles.py:247`
- `/home/sf/src/geko-template/webapp/app/routes/upload.py` (for image captions)

---

## Open Questions

1. **Model persistence:** Should model selection persist per article (store which model generated the summary)?
2. **Cost tracking:** Should the system log token usage for different models?
3. **Model parameters:** Should temperature/max_tokens also be configurable?
4. **Validation:** Should the config panel validate that model IDs are valid before saving?
5. **Migration:** How to handle existing articles when model changes?
