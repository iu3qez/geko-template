{% extends "standard/base.html" %}
<!--
    Form Articolo - ModalitÃ  Standard

    Form per creare o modificare un articolo.
    Include:
    - Campi metadati (titolo, autore, ecc.)
    - Editor markdown WYSIWYG (EasyMDE) o textarea semplice
    - Preview in tempo reale

    Variabili:
    - article: oggetto Article (None per nuovo articolo)

    Editor:
    - WYSIWYG: toolbar, preview split, drag&drop immagini
    - Plain: textarea semplice per chi preferisce
    - Toggle salvato in localStorage
-->

{% block title %}
{% if article %}Modifica Articolo{% else %}Nuovo Articolo{% endif %} - GEKO Magazine
{% endblock %}

{% block styles %}
{{ super() }}
<!-- EasyMDE CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<style>
    /* Personalizzazione editor */
    .EasyMDEContainer {
        border-radius: var(--radius-md);
    }
    .EasyMDEContainer .CodeMirror {
        border-radius: 0 0 var(--radius-md) var(--radius-md);
        min-height: 300px;
    }
    .editor-toolbar {
        border-radius: var(--radius-md) var(--radius-md) 0 0;
        background: var(--geko-light);
    }
    .editor-toolbar button.active,
    .editor-toolbar button:hover {
        background: var(--geko-gold);
        color: white;
    }
    .editor-mode-toggle {
        display: flex;
        justify-content: flex-end;
        margin-bottom: var(--space-sm);
    }
    .editor-mode-toggle button {
        font-size: 0.875rem;
        padding: 4px 8px;
    }
</style>
{% endblock %}

{% block main %}
<div class="form-container">

    <header class="page-header">
        <h1>{% if article %}Modifica Articolo{% else %}Nuovo Articolo{% endif %}</h1>
    </header>

    <form
        {% if article %}
        hx-put="/articles/{{ article.id }}"
        {% else %}
        hx-post="/articles/"
        {% endif %}
        hx-target="#form-result"
        class="article-form"
    >
        <!-- METADATI -->
        <fieldset class="form-section">
            <legend>Informazioni Articolo</legend>

            <div class="form-group">
                <label for="titolo">Titolo *</label>
                <input
                    type="text"
                    id="titolo"
                    name="titolo"
                    value="{{ article.titolo if article else '' }}"
                    required
                    placeholder="Es: Costruiamo un RTX QRP per i 40m"
                >
            </div>

            <div class="form-group">
                <label for="sottotitolo">Sottotitolo</label>
                <input
                    type="text"
                    id="sottotitolo"
                    name="sottotitolo"
                    value="{{ article.sottotitolo if article else '' }}"
                    placeholder="Es: Un progetto semplice per iniziare"
                >
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="autore">Nominativo Radio</label>
                    <input
                        type="text"
                        id="autore"
                        name="autore"
                        value="{{ article.autore if article else '' }}"
                        placeholder="Es: IU3QEZ"
                    >
                </div>

                <div class="form-group">
                    <label for="nome_autore">Nome</label>
                    <input
                        type="text"
                        id="nome_autore"
                        name="nome_autore"
                        value="{{ article.nome_autore if article else '' }}"
                        placeholder="Es: Simone"
                    >
                </div>
            </div>
        </fieldset>

        <!-- CONTENUTO + LIBRERIA IMMAGINI -->
        <fieldset class="form-section">
            <legend>Contenuto (Markdown)</legend>

            <div class="editor-with-library">
                <!-- COLONNA SINISTRA: Editor -->
                <div class="editor-column">
                    <!-- Toggle modalitÃ  editor -->
                    <div class="editor-mode-toggle">
                        <button type="button" class="btn btn-small btn-outline" onclick="GekoEditor.toggle()">
                            ðŸ”„ Cambia Editor
                        </button>
                        <button type="button" class="btn btn-small btn-outline" onclick="toggleLibrary()">
                            ðŸ“· Libreria Immagini
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="contenuto_md">
                            Scrivi il contenuto
                            <span class="text-muted">(con toolbar e preview)</span>
                        </label>
                        <textarea
                            id="contenuto_md"
                            name="contenuto_md"
                            rows="20"
                            data-editor="wysiwyg"
                            data-article-id="{{ article.id if article else 'new' }}"
                            placeholder="Scrivi qui il tuo articolo...

## Sezione

Testo normale con **grassetto** e *corsivo*.

- Lista puntata
- Altro elemento

![Descrizione immagine](percorso/immagine.jpg)"
                        >{{ article.contenuto_md if article else '' }}</textarea>
                    </div>
                </div>

                <!-- COLONNA DESTRA: Libreria Immagini -->
                <div class="library-column" id="library-panel" style="display: none;">
                    <div class="library-panel-header">
                        <h3>Libreria Immagini</h3>
                        <button type="button" class="btn-close" onclick="toggleLibrary()">âœ•</button>
                    </div>
                    <div
                        id="library-content"
                        hx-get="/upload/library"
                        hx-trigger="revealed"
                        hx-swap="innerHTML"
                    >
                        <p>Caricamento...</p>
                    </div>
                </div>
            </div>

            <!-- Help Markdown (visibile solo in modalitÃ  plain) -->
            <details class="markdown-help" id="markdown-help">
                <summary>Guida rapida Markdown</summary>
                <div class="help-content">
                    <table>
                        <tr><td><code># Titolo</code></td><td>Titolo principale</td></tr>
                        <tr><td><code>## Sezione</code></td><td>Sottosezione</td></tr>
                        <tr><td><code>**grassetto**</code></td><td><strong>grassetto</strong></td></tr>
                        <tr><td><code>*corsivo*</code></td><td><em>corsivo</em></td></tr>
                        <tr><td><code>- elemento</code></td><td>Lista puntata</td></tr>
                        <tr><td><code>[testo](url)</code></td><td>Link</td></tr>
                        <tr><td><code>![alt](path)</code></td><td>Immagine</td></tr>
                        <tr><td><code>!!! nota "Titolo"</code></td><td>Box evidenza</td></tr>
                    </table>
                </div>
            </details>
        </fieldset>

        <!-- AZIONI -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-large">
                {% if article %}ðŸ’¾ Salva Modifiche{% else %}âž• Crea Articolo{% endif %}
            </button>
            <a href="/articles/" class="btn btn-secondary">Annulla</a>
        </div>

        <!-- Risultato (per feedback HTMX) -->
        <div id="form-result"></div>

    </form>

    <!-- UPLOAD MARKDOWN (solo nuovo articolo) -->
    {% if not article %}
    <div class="alternative-upload">
        <h3>Oppure importa da file</h3>
        <form
            hx-post="/upload/markdown"
            hx-target="#form-result"
            hx-encoding="multipart/form-data"
        >
            <input type="file" name="file" accept=".md" required>
            <button type="submit" class="btn btn-outline">ðŸ“¤ Importa .md</button>
        </form>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
<!-- EasyMDE Library -->
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<!-- GEKO Editor -->
<script src="/static/js/editor.js"></script>
<script>
    // Inizializza editor quando la pagina Ã¨ pronta
    document.addEventListener('DOMContentLoaded', function() {
        const editor = GekoEditor.init('contenuto_md');

        // Nascondi help markdown se editor WYSIWYG Ã¨ attivo
        if (editor) {
            document.getElementById('markdown-help').style.display = 'none';
        }
    });

    // Toggle pannello libreria immagini
    function toggleLibrary() {
        const panel = document.getElementById('library-panel');
        const content = document.getElementById('library-content');
        const isVisible = panel.style.display !== 'none';
        panel.style.display = isVisible ? 'none' : 'block';

        // Carica contenuto se non ancora caricato (prima apertura)
        if (!isVisible && content.innerHTML.trim() === '<p>Caricamento...</p>') {
            htmx.ajax('GET', '/upload/library', {target: '#library-content', swap: 'innerHTML'});
        }
    }

    // Inserisce immagine dalla libreria nell'editor
    function insertImageFromLibrary(element) {
        const url = element.dataset.url;
        const alt = element.dataset.alt || 'Immagine';

        const markdown = `![${alt}](${url})`;

        // Inserisci nel editor (WYSIWYG o plain)
        const editor = GekoEditor.getInstance();
        if (editor) {
            // EasyMDE: inserisci alla posizione del cursore
            const cm = editor.codemirror;
            cm.replaceSelection(markdown);
            cm.focus();
        } else {
            // Plain textarea: inserisci alla fine o alla posizione del cursore
            const textarea = document.getElementById('contenuto_md');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + markdown + text.substring(end);
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + markdown.length;
        }

        // Feedback visivo
        element.classList.add('inserted');
        setTimeout(() => element.classList.remove('inserted'), 500);
    }
</script>
{% endblock %}
