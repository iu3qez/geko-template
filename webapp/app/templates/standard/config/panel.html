{% extends "standard/base.html" %}
<!--
    Pannello Configurazione - Impostazioni globali GEKO Magazine

    Permette di modificare:
    - Ultimo numero pubblicato
    - Titolo e sottotitolo rivista
    - Contatti (sito, email)
    - (futuro) Template Typst
-->

{% block title %}Configurazione - GEKO Magazine{% endblock %}

{% block main %}
<div class="config-container">

    <header class="page-header">
        <h1>Configurazione</h1>
        <p class="page-subtitle">Impostazioni globali della rivista</p>
    </header>

    {% if message %}
    <div class="alert alert-success">
        {{ message }}
    </div>
    {% endif %}

    <form
        method="post"
        action="/config/"
        class="config-form"
    >
        <!-- Informazioni Rivista -->
        <fieldset class="form-section">
            <legend>Informazioni Rivista</legend>

            <div class="form-group">
                <label for="ultimo_numero">Ultimo numero pubblicato</label>
                <input
                    type="text"
                    id="ultimo_numero"
                    name="ultimo_numero"
                    value="{{ configs.ultimo_numero.value }}"
                    placeholder="Es: 67"
                    class="input-small"
                >
                <span class="form-hint">{{ configs.ultimo_numero.description }}</span>
            </div>

            <div class="form-group">
                <label for="titolo_rivista">Titolo rivista</label>
                <input
                    type="text"
                    id="titolo_rivista"
                    name="titolo_rivista"
                    value="{{ configs.titolo_rivista.value }}"
                    placeholder="GEKO Radio Magazine"
                >
                <span class="form-hint">{{ configs.titolo_rivista.description }}</span>
            </div>

            <div class="form-group">
                <label for="sottotitolo_rivista">Sottotitolo</label>
                <input
                    type="text"
                    id="sottotitolo_rivista"
                    name="sottotitolo_rivista"
                    value="{{ configs.sottotitolo_rivista.value }}"
                    placeholder="Rivista aperiodica del Mountain QRP Club"
                >
                <span class="form-hint">{{ configs.sottotitolo_rivista.description }}</span>
            </div>
        </fieldset>

        <!-- Contatti -->
        <fieldset class="form-section">
            <legend>Contatti</legend>

            <div class="form-group">
                <label for="sito_web">Sito web</label>
                <input
                    type="url"
                    id="sito_web"
                    name="sito_web"
                    value="{{ configs.sito_web.value }}"
                    placeholder="https://www.mqc.it"
                >
                <span class="form-hint">{{ configs.sito_web.description }}</span>
            </div>

            <div class="form-group">
                <label for="email_redazione">Email redazione</label>
                <input
                    type="email"
                    id="email_redazione"
                    name="email_redazione"
                    value="{{ configs.email_redazione.value }}"
                    placeholder="redazione@mqc.it"
                >
                <span class="form-hint">{{ configs.email_redazione.description }}</span>
            </div>
        </fieldset>

        <!-- Impostazioni AI -->
        <fieldset class="form-section">
            <legend>Impostazioni AI</legend>

            <div class="form-group">
                <label for="claude_model">Modello Claude</label>
                <select
                    id="claude_model"
                    name="claude_model"
                    class="input-select"
                >
                    <option value="claude-3-5-haiku-20241022" {% if configs.claude_model.value == "claude-3-5-haiku-20241022" %}selected{% endif %}>
                        Haiku 3.5 - Veloce ed economico
                    </option>
                    <option value="claude-sonnet-4-20250514" {% if configs.claude_model.value == "claude-sonnet-4-20250514" %}selected{% endif %}>
                        Sonnet 4 - Pi√π capace, pi√π costoso
                    </option>
                </select>
                <span class="form-hint">{{ configs.claude_model.description }}</span>
            </div>
        </fieldset>

        <!-- Template (futuro) -->
        <fieldset class="form-section form-section-disabled">
            <legend>Template Typst (prossimamente)</legend>
            <p class="text-muted">
                In futuro sar√† possibile personalizzare il template Typst direttamente da qui.
            </p>
        </fieldset>

        <!-- Azioni -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-large">
                Salva configurazione
            </button>
        </div>

    </form>

    <!-- Strumenti AI -->
    <fieldset class="form-section" style="margin-top: 2rem;">
        <legend>Strumenti AI</legend>

        <div class="form-group">
            <label>Rigenera didascalie immagini</label>
            <p class="form-hint" style="margin-bottom: 1rem;">
                Genera automaticamente didascalie per tutte le immagini caricate usando Claude Vision.
                Le immagini verranno anche rinominate con nomi descrittivi.
                <strong>Attenzione:</strong> questa operazione pu√≤ richiedere tempo e consumare token API.
            </p>
            <button
                type="button"
                class="btn btn-secondary"
                id="regenerate-captions-btn"
                onclick="regenerateCaptions()"
            >
                üîÑ Rigenera tutte le didascalie
            </button>
            <div id="regenerate-result" style="margin-top: 1rem;"></div>
        </div>
    </fieldset>

</div>

<script>
async function regenerateCaptions() {
    const btn = document.getElementById('regenerate-captions-btn');
    const result = document.getElementById('regenerate-result');

    if (!confirm('Sei sicuro? Questa operazione rigenerer√† le didascalie di TUTTE le immagini e le rinominer√†.')) {
        return;
    }

    btn.disabled = true;
    btn.textContent = '‚è≥ Elaborazione in corso...';
    result.innerHTML = '<p class="text-muted">Attendere, generazione didascalie in corso...</p>';

    try {
        const response = await fetch('/upload/regenerate-captions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.status === 'completed') {
            const stats = data.stats;
            result.innerHTML = `
                <div class="alert alert-success">
                    <strong>Completato!</strong><br>
                    Totale immagini: ${stats.total}<br>
                    Aggiornate: ${stats.success}<br>
                    Saltate: ${stats.skipped}<br>
                    Errori: ${stats.errors}
                </div>
            `;
        } else {
            result.innerHTML = '<div class="alert alert-error">Errore durante l\'elaborazione</div>';
        }
    } catch (error) {
        result.innerHTML = `<div class="alert alert-error">Errore: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Rigenera tutte le didascalie';
    }
}
</script>
{% endblock %}
